import sys
import os
import sqlite3
from PySide6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QLabel, QPushButton, QLineEdit,
    QFormLayout, QMessageBox, QStackedWidget, QHBoxLayout, QCheckBox,
    QComboBox, QCalendarWidget, QTimeEdit, QSlider, QTextEdit
)
from PySide6.QtCore import Qt, QDate
from PySide6.QtGui import QPixmap, QFontDatabase, QFont
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure

# -------------------- DATABASE SETUP -------------------- #
sql = """
CREATE TABLE "User" ( 
"userID" INTEGER PRIMARY KEY AUTOINCREMENT,
"user_name" TEXT,
"user_firstname" TEXT,
"user_surname" TEXT,
"user_password" TEXT,
"user_email" TEXT,
"u_sub" INTEGER 
);
CREATE TABLE "Session" (
"SessionID" INTEGER PRIMARY KEY AUTOINCREMENT,
"Session_date" TEXT,
"Session_duration" INTEGER,
"Session_type" TEXT,
"userID"  INTEGER,
FOREIGN KEY(userID) REFERENCES User(userID)
);
CREATE TABLE "Booking" (
"BookingID" INTEGER PRIMARY KEY AUTOINCREMENT,
"Booking_timeslot" TEXT,
"Booking_date" TEXT,
"userID"  INTEGER,
"TrainerID"  INTEGER,
FOREIGN KEY(userID) REFERENCES User(userID),
FOREIGN KEY(TrainerID) REFERENCES Trainer(TrainerID)
);
CREATE TABLE "Trainer" (
"TrainerID" INTEGER PRIMARY KEY AUTOINCREMENT,
"Trainer_Name" TEXT,
"Trainer_EXP" TEXT,
"Trainer_Gender" TEXT,
"Trainer_DOB" TEXT
);
insert into User (user_name, user_firstname, user_surname, user_password, user_email, u_sub) 
values ('UJoe', 'Strummer', 'Joe', 'pw1', 'Joe@gmail.com', '0');
insert into User (user_name, user_firstname, user_surname, user_password, user_email, u_sub) 
values ('UBren', 'Brencis', 'Imaz', 'pw21', 'B@gmail.com', '1');

insert into Session (Session_date, Session_duration, Session_type, userID) 
values ('14/09/2025', '60', 'Fitness', '1');
insert into Session (Session_date, Session_duration, Session_type, userID) 
values ('21/09/2025', '90', 'Running', '1');

insert into Booking (Booking_timeslot, Booking_date, TrainerID, UserID) 
values ('7PM', '10/09/2025', '1', '1');
insert into Booking (Booking_timeslot, Booking_date, TrainerID, UserID) 
values ('9PM', '10/09/2025', '2', '2');

insert into Trainer (Trainer_Name, Trainer_EXP, Trainer_Gender, Trainer_DOB) 
values ('James', 'Advanced', 'Male', '15/06/2000');
insert into Trainer (Trainer_Name, Trainer_EXP, Trainer_Gender, Trainer_DOB) 
values ('Mia', 'Trainee', 'Female', '27/09/2001');
"""

DB_FILE = "GYM.db"
if os.path.exists(DB_FILE):
    os.remove(DB_FILE)

conn = sqlite3.connect(DB_FILE)
conn.executescript(sql)
conn.commit()
conn.close()

def query_database(query, params=()):
    with sqlite3.connect(DB_FILE) as conn:
        cur = conn.cursor()
        cur.execute(query, params)
        return cur.fetchall()

def execute_sql(query, params=()):
    with sqlite3.connect(DB_FILE) as conn:
        cur = conn.cursor()
        cur.execute(query, params)
        conn.commit()
        return cur.lastrowid


# -------------------- MAIN MENU -------------------- #
class MainMenu(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack
        layout = QVBoxLayout()
        layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        # --- Add the image ---
        image_label = QLabel()
        pixmap = QPixmap("TokaImage.png")  # Ensure file exists
        if not pixmap.isNull():
            image_label.setPixmap(pixmap.scaled(200, 200, Qt.AspectRatioMode.KeepAspectRatio))
            image_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            layout.addWidget(image_label)
        else:
            print("⚠️ Could not find TokaImage.png")

        title = QLabel("Welcome to TOKAFITNESS")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        title.setStyleSheet("font-size: 22px; font-weight: bold;")

        subtitle = QLabel("Please select an option below:")
        subtitle.setAlignment(Qt.AlignmentFlag.AlignCenter)

        btn_login = QPushButton("Login")
        btn_login.setStyleSheet("background-color: lightblue;")
        btn_login.clicked.connect(lambda: parent_stack.setCurrentIndex(1))

        btn_signup = QPushButton("Sign Up")
        btn_signup.setStyleSheet("background-color: lightgreen;")
        btn_signup.clicked.connect(lambda: parent_stack.setCurrentIndex(2))

        layout.addWidget(title)
        layout.addWidget(subtitle)
        layout.addWidget(btn_login)
        layout.addWidget(btn_signup)
        self.setLayout(layout)


# -------------------- SIGNUP WINDOW -------------------- #
class SignupWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack

        layout = QVBoxLayout()
        title = QLabel("Create your account")
        title.setStyleSheet("font-size: 18px; font-weight: bold;")
        layout.addWidget(title, alignment=Qt.AlignmentFlag.AlignCenter)

        form = QFormLayout()
        self.username = QLineEdit()
        self.password = QLineEdit()
        self.password.setEchoMode(QLineEdit.EchoMode.Password)
        self.confirm = QLineEdit()
        self.confirm.setEchoMode(QLineEdit.EchoMode.Password)
        self.firstname = QLineEdit()
        self.surname = QLineEdit()
        self.email = QLineEdit()

        form.addRow("Username:", self.username)
        form.addRow("Password:", self.password)
        form.addRow("Confirm Password:", self.confirm)
        form.addRow("First Name:", self.firstname)
        form.addRow("Surname:", self.surname)
        form.addRow("Email:", self.email)

        layout.addLayout(form)

        btn_create = QPushButton("Create Account")
        btn_create.setStyleSheet("background-color: lightgreen;")
        btn_create.clicked.connect(self.create_account)

        btn_back = QPushButton("Back")
        btn_back.setStyleSheet("background-color: lightblue;")
        btn_back.clicked.connect(lambda: parent_stack.setCurrentIndex(0))

        layout.addWidget(btn_create)
        layout.addWidget(btn_back)
        self.setLayout(layout)

    def create_account(self):
        username = self.username.text().strip()
        password = self.password.text().strip()
        confirm = self.confirm.text().strip()
        firstname = self.firstname.text().strip()
        surname = self.surname.text().strip()
        email = self.email.text().strip()

        if not username.isalpha():
            QMessageBox.warning(self, "Error", "Username cannot contain numbers or symbols")
            return
        if not firstname.isalpha():
            QMessageBox.warning(self, "Error", "First name cannot contain numbers or symbols")
            return
        if password != confirm:
            QMessageBox.warning(self, "Error", "Passwords do not match")
            return
        if not all([username, password, firstname, surname, email]):
            QMessageBox.warning(self, "Error", "Please fill in all fields")
            return

        try:
            execute_sql(
                "INSERT INTO User (user_name, user_firstname, user_surname, user_password, user_email) VALUES (?, ?, ?, ?, ?)",
                (username, firstname, surname, password, email)
            )
            QMessageBox.information(self, "Success", "Account successfully created")
            self.parent_stack.setCurrentIndex(0)
        except Exception as e:
            QMessageBox.critical(self, "Error", str(e))


# -------------------- LOGIN WINDOW -------------------- #
class LoginWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack

        layout = QVBoxLayout()
        title = QLabel("Login to your account")
        title.setStyleSheet("font-size: 18px; font-weight: bold;")
        layout.addWidget(title, alignment=Qt.AlignmentFlag.AlignCenter)

        form = QFormLayout()
        self.username = QLineEdit()
        self.password = QLineEdit()
        self.password.setEchoMode(QLineEdit.EchoMode.Password)
        form.addRow("Username:", self.username)
        form.addRow("Password:", self.password)
        layout.addLayout(form)

        self.cookies_box = QCheckBox("I accept cookies")
        self.terms_box = QCheckBox("I accept the Terms & Conditions")

        layout.addWidget(self.cookies_box)
        layout.addWidget(self.terms_box)

        btn_login = QPushButton("Login")
        btn_login.setStyleSheet("background-color: lightblue;")
        btn_login.clicked.connect(self.login_user)

        btn_back = QPushButton("Back")
        btn_back.setStyleSheet("background-color: lightblue;")
        btn_back.clicked.connect(lambda: parent_stack.setCurrentIndex(0))

        btn_forgot = QPushButton("Forgot Password?")
        btn_forgot.setStyleSheet("color: blue; background: none; border: none; text-decoration: underline;")
        btn_forgot.clicked.connect(lambda: parent_stack.setCurrentIndex(3))

        layout.addWidget(btn_login)
        layout.addWidget(btn_back)
        layout.addWidget(btn_forgot)
        self.setLayout(layout)

    def login_user(self):
        username = self.username.text().strip()
        password = self.password.text().strip()

        if not self.cookies_box.isChecked() or not self.terms_box.isChecked():
            QMessageBox.warning(self, "Error", "You must accept cookies and the Terms & Conditions to continue.")
            return

        if not username or not password:
            QMessageBox.warning(self, "Error", "Please fill in all fields")
            return

        rows = query_database(
            "SELECT * FROM User WHERE user_name = ? AND user_password = ?",
            (username, password)
        )
        if not rows:
            QMessageBox.warning(self, "Error", "Invalid username or password")
        else:
            QMessageBox.information(self, "Success", f"Welcome {username}!")
            main_window = self.parent_stack.parentWidget()
            main_window.current_user = username
            dashboard = self.parent_stack.widget(4)
            dashboard.update_welcome(username)
            self.parent_stack.setCurrentIndex(4)


# -------------------- FORGOT PASSWORD WINDOW -------------------- #
class ForgotPasswordWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack

        layout = QVBoxLayout()
        title = QLabel("Reset Your Password")
        title.setStyleSheet("font-size: 18px; font-weight: bold;")
        layout.addWidget(title, alignment=Qt.AlignmentFlag.AlignCenter)

        form = QFormLayout()
        self.username = QLineEdit()
        self.email = QLineEdit()
        self.new_pw = QLineEdit()
        self.new_pw.setEchoMode(QLineEdit.EchoMode.Password)
        self.confirm_pw = QLineEdit()
        self.confirm_pw.setEchoMode(QLineEdit.EchoMode.Password)

        form.addRow("Username:", self.username)
        form.addRow("Email:", self.email)
        form.addRow("New Password:", self.new_pw)
        form.addRow("Confirm Password:", self.confirm_pw)
        layout.addLayout(form)

        btn_reset = QPushButton("Change Password")
        btn_reset.setStyleSheet("background-color: lightblue;")
        btn_reset.clicked.connect(self.change_password)

        btn_back = QPushButton("Back")
        btn_back.setStyleSheet("background-color: lightblue;")
        btn_back.clicked.connect(lambda: parent_stack.setCurrentIndex(1))

        layout.addWidget(btn_reset)
        layout.addWidget(btn_back)
        self.setLayout(layout)

    def change_password(self):
        username = self.username.text().strip()
        email = self.email.text().strip()
        new_pw = self.new_pw.text().strip()
        confirm_pw = self.confirm_pw.text().strip()

        if not all([username, email, new_pw, confirm_pw]):
            QMessageBox.warning(self, "Error", "Please fill in all fields")
            return

        if new_pw != confirm_pw:
            QMessageBox.warning(self, "Error", "Passwords do not match")
            return

        rows = query_database("SELECT * FROM User WHERE user_name = ? AND user_email = ?", (username, email))
        if not rows:
            QMessageBox.warning(self, "Error", "User not found. Please check your username and email.")
            return

        execute_sql("UPDATE User SET user_password = ? WHERE user_name = ? AND user_email = ?", (new_pw, username, email))
        QMessageBox.information(self, "Success", "Password successfully updated!")
        self.parent_stack.setCurrentIndex(1)


# -------------------- DASHBOARD WINDOW -------------------- #
class DashboardWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack
        self.user_is_premium = False  # Default to free membership

        # Advice Button
        self.btn_Advice = QPushButton("Advice")
        self.btn_Advice.setStyleSheet("background-color: #A7C7E7;")  # Pastel blue shade
        self.btn_Advice.clicked.connect(lambda: parent_stack.setCurrentIndex(5))

        # Booking Button
        self.btn_Booking = QPushButton("Booking")
        self.btn_Booking.setStyleSheet("background-color: #B3D9FF;")  # Pastel blue shade
        self.btn_Booking.clicked.connect(lambda: parent_stack.setCurrentIndex(6))

        # Premium Button
        self.btn_Premium = QPushButton("Premium")
        self.btn_Premium.setStyleSheet("background-color: gold;")  # Gold color for Premium
        self.btn_Premium.clicked.connect(lambda: parent_stack.setCurrentIndex(7))

        # Tracking Button
        self.btn_Tracking = QPushButton("Tracking")
        self.btn_Tracking.setStyleSheet("background-color: #C2E2FF;")  # Pastel blue shade
        self.btn_Tracking.clicked.connect(lambda: parent_stack.setCurrentIndex(8))

        # Social Button
        self.btn_Social = QPushButton("Social")
        self.btn_Social.setStyleSheet("background-color: #D1ECFF;")  # Pastel blue shade
        self.btn_Social.clicked.connect(lambda: parent_stack.setCurrentIndex(9))

        # Settings Button
        self.btn_Settings = QPushButton("Settings")
        self.btn_Settings.setStyleSheet("background-color: #E0F5FF;")  # Pastel blue shade
        self.btn_Settings.clicked.connect(lambda: parent_stack.setCurrentIndex(10))

        # Log Out Button
        self.btn_LogOut = QPushButton("Log out")
        self.btn_LogOut.setStyleSheet("background-color: #A7C7E7;")  # Pastel blue shade
        self.btn_LogOut.clicked.connect(lambda: parent_stack.setCurrentIndex(0))

        # Add buttons to layout
        top_layout = QHBoxLayout()
        for b in [
            self.btn_Advice,
            self.btn_Booking,
            self.btn_Premium,
            self.btn_Tracking,
            self.btn_Social,
            self.btn_Settings,
            self.btn_LogOut,
        ]:
            top_layout.addWidget(b)

        self.title = QLabel("WELCOME TO TOKA FITNESS")
        self.title.setStyleSheet("font-size: 18px; font-weight: bold;")
        self.title.setAlignment(Qt.AlignmentFlag.AlignCenter)

        self.subtitle = QLabel("")
        self.subtitle.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.subtitle.setStyleSheet("font-size: 14px;")

        # Add Gym Photo
        self.photo_label = QLabel()
        pixmap = QPixmap("GymPhoto.png")  # Ensure GymPhoto.png exists in the directory
        if not pixmap.isNull():
            self.photo_label.setPixmap(pixmap.scaled(1000, 400, Qt.AspectRatioMode.KeepAspectRatio))
            self.photo_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        else:
            print("⚠️ Could not find GymPhoto.png")

        main_layout = QVBoxLayout()
        main_layout.addLayout(top_layout)
        main_layout.addWidget(self.title)
        main_layout.addWidget(self.subtitle)
        main_layout.addWidget(self.photo_label)
        main_layout.addStretch()
        self.setLayout(main_layout)

    def update_welcome(self, username):
        self.subtitle.setText(f"Welcome {username}!")

        # Check if the user is premium
        user_data = query_database("SELECT u_sub FROM User WHERE user_name = ?", (username,))
        if user_data and user_data[0][0] == 1:
            self.user_is_premium = True
        else:
            self.user_is_premium = False
            self.subtitle.setText(f"Enjoy your free content, Subscribe to Premium now for more content!!!")

        # Update button states based on membership
        self.update_button_states()

    def update_button_states(self):
        if self.user_is_premium:
            # Enable all buttons for premium users
            self.btn_Advice.setEnabled(True)
            self.btn_Advice.setStyleSheet("background-color: #A7C7E7;")
            self.btn_Tracking.setEnabled(True)
            self.btn_Tracking.setStyleSheet("background-color: #C2E2FF;")
            self.btn_Social.setEnabled(True)
            self.btn_Social.setStyleSheet("background-color: #D1ECFF;")
        else:
            # Lock certain buttons for free users
            self.btn_Advice.setEnabled(False)
            self.btn_Advice.setStyleSheet("background-color: grey; color: white;")
            self.btn_Tracking.setEnabled(False)
            self.btn_Tracking.setStyleSheet("background-color: grey; color: white;")
            self.btn_Social.setEnabled(False)
            self.btn_Social.setStyleSheet("background-color: grey; color: white;")


# -------------------- SIMPLE WINDOWS -------------------- #
class AdviceWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        layout = QVBoxLayout()
        title = QLabel("Advice")
        title.setStyleSheet("font-size: 18px; font-weight: bold;")
        layout.addWidget(title, alignment=Qt.AlignmentFlag.AlignCenter)
        btn_back = QPushButton("Back")
        btn_back.setStyleSheet("background-color: lightblue;")
        btn_back.clicked.connect(lambda: parent_stack.setCurrentIndex(4))
        


        image_label = QLabel()
        pixmap = QPixmap("Advice.png")  # Ensure file exists
        if not pixmap.isNull():
            image_label.setPixmap(pixmap.scaled(1000, 400, Qt.AspectRatioMode.KeepAspectRatio))
            image_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            layout.addWidget(image_label)
        else:
            print("⚠️ Could not find Advice.png")




        
        layout.addWidget(btn_back)
        self.setLayout(layout)


class BookingWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack

        layout = QVBoxLayout()
        title = QLabel("Booking")
        title.setStyleSheet("font-size: 18px; font-weight: bold;")
        layout.addWidget(title, alignment=Qt.AlignmentFlag.AlignCenter)

        self.trainer_dropdown = QComboBox()
        trainers = query_database("SELECT TrainerID, Trainer_Name FROM Trainer")
        for trainer in trainers:
            self.trainer_dropdown.addItem(trainer[1], trainer[0])
        layout.addWidget(QLabel("Select Trainer:"))
        layout.addWidget(self.trainer_dropdown)

        self.calendar = QCalendarWidget()
        layout.addWidget(QLabel("Select Date:"))
        layout.addWidget(self.calendar)

        self.time_input = QTimeEdit()
        self.time_input.setDisplayFormat("HH:mm")
        layout.addWidget(QLabel("Select Time:"))
        layout.addWidget(self.time_input)

        btn_confirm = QPushButton("Confirm Booking")
        btn_confirm.setStyleSheet("background-color: lightgreen;")
        btn_confirm.clicked.connect(self.confirm_booking)
        layout.addWidget(btn_confirm)

        btn_back = QPushButton("Back")
        btn_back.setStyleSheet("background-color: lightblue;")
        btn_back.clicked.connect(lambda: parent_stack.setCurrentIndex(4))
        layout.addWidget(btn_back)

        self.setLayout(layout)

    def confirm_booking(self):
        trainer_id = self.trainer_dropdown.currentData()
        selected_date = self.calendar.selectedDate().toString("yyyy-MM-dd")
        selected_time = self.time_input.time().toString("HH:mm")

        try:
            user_id = query_database(
                "SELECT userID FROM User WHERE user_name = ?",
                (self.parent_stack.parentWidget().current_user,)
            )[0][0]
            execute_sql(
                "INSERT INTO Booking (Booking_timeslot, Booking_date, TrainerID, userID) VALUES (?, ?, ?, ?)",
                (selected_time, selected_date, trainer_id, user_id)
            )
            due_date = QDate.fromString(selected_date, "yyyy-MM-dd").addDays(7).toString("yyyy-MM-dd")
            QMessageBox.information(self, "Success", f"Booking confirmed! Your due date is {due_date}.")
        except Exception as e:
            QMessageBox.critical(self, "Error", f"Failed to confirm booking: {str(e)}")


class PremiumWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack

        # Main layout
        main_layout = QVBoxLayout()
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        main_layout.setContentsMargins(20, 20, 20, 20)
        main_layout.setSpacing(15)

        # Title
        title = QLabel("Premium Membership Options")
        title.setStyleSheet("font-size: 22px; font-weight: bold; color: #333;")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        main_layout.addWidget(title)

        # Membership Comparison Section
        comparison_section = QHBoxLayout()
        comparison_section.setSpacing(20)

        # Free Membership Section
        free_layout = QVBoxLayout()
        free_title = QLabel("Free Membership")
        free_title.setStyleSheet("font-size: 18px; font-weight: bold; color: #555;")
        free_layout.addWidget(free_title, alignment=Qt.AlignmentFlag.AlignCenter)

        free_features = [
            ("Access to basic workouts", True),
            ("Personalized advice", False),
            ("Booking trainers", True),
            ("Social features", False),
        ]

        for feature, available in free_features:
            feature_label = QLabel(f"{'✔️' if available else '❌'} {feature}")
            feature_label.setStyleSheet("font-size: 14px; color: #777;")
            free_layout.addWidget(feature_label)

        comparison_section.addLayout(free_layout)

        # Premium Membership Section
        premium_layout = QVBoxLayout()
        premium_title = QLabel("Premium Membership")
        premium_title.setStyleSheet("font-size: 18px; font-weight: bold; color: gold;")
        premium_layout.addWidget(premium_title, alignment=Qt.AlignmentFlag.AlignCenter)

        premium_features = [
            ("Access to basic workouts", True),
            ("Personalized advice", True),
            ("Booking trainers", True),
            ("Social features", True),
        ]

        for feature, available in premium_features:
            feature_label = QLabel(f"{'✔️' if available else '❌'} {feature}")
            feature_label.setStyleSheet("font-size: 14px; color: #777;")
            premium_layout.addWidget(feature_label)

        comparison_section.addLayout(premium_layout)

        main_layout.addLayout(comparison_section)

        # Membership Selection Buttons
        button_section = QHBoxLayout()
        button_section.setSpacing(20)

        btn_free = QPushButton("Choose Free Membership")
        btn_free.setStyleSheet("""
            background-color: #4CAF50;
            color: white;
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
        """)
        btn_free.clicked.connect(self.choose_free_membership)
        button_section.addWidget(btn_free)

        btn_premium = QPushButton("Choose Premium Membership")
        btn_premium.setStyleSheet("""
            background-color: gold;
            color: black;
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
        """)
        btn_premium.clicked.connect(self.choose_premium_membership)
        button_section.addWidget(btn_premium)

        main_layout.addLayout(button_section)

        # Back Button
        btn_back = QPushButton("Back")
        btn_back.setStyleSheet("""
            background-color: #4CAF50;
            color: white;
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
        """)
        btn_back.clicked.connect(lambda: self.parent_stack.setCurrentIndex(4))
        main_layout.addWidget(btn_back, alignment=Qt.AlignmentFlag.AlignCenter)

        self.setLayout(main_layout)

    def choose_free_membership(self):
        # Update the user's membership status in the database
        current_user = self.parent_stack.parentWidget().current_user
        execute_sql("UPDATE User SET u_sub = 0 WHERE user_name = ?", (current_user,))

        QMessageBox.information(self, "Membership Updated", "You have switched to Free Membership.")

        # Notify the Dashboard to refresh button states
        dashboard = self.parent_stack.widget(4)
        dashboard.update_welcome(current_user)

        self.parent_stack.setCurrentIndex(4)

    def choose_premium_membership(self):
        # Update the user's membership status in the database
        current_user = self.parent_stack.parentWidget().current_user
        execute_sql("UPDATE User SET u_sub = 1 WHERE user_name = ?", (current_user,))

        QMessageBox.information(self, "Membership Updated", "You have chosen the Premium Membership. Enjoy the benefits!")

        # Notify the Dashboard to refresh button states
        dashboard = self.parent_stack.widget(4)
        dashboard.update_welcome(current_user)

        self.parent_stack.setCurrentIndex(4)


class TrackingWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack
        self.steps_data = []  # List to store step data

        layout = QVBoxLayout()
        title = QLabel("Tracking")
        title.setStyleSheet("font-size: 18px; font-weight: bold;")
        layout.addWidget(title, alignment=Qt.AlignmentFlag.AlignCenter)

        # Input field for steps
        self.steps_input = QLineEdit()
        self.steps_input.setPlaceholderText("Enter the number of steps")
        layout.addWidget(self.steps_input)

        # Button to add steps
        btn_add_steps = QPushButton("Add Steps")
        btn_add_steps.setStyleSheet("background-color: lightgreen;")
        btn_add_steps.clicked.connect(self.add_steps)
        layout.addWidget(btn_add_steps)

        # Button to go back
        btn_back = QPushButton("Back")
        btn_back.setStyleSheet("background-color: lightblue;")
        btn_back.clicked.connect(lambda: parent_stack.setCurrentIndex(4))
        layout.addWidget(btn_back)

        # Matplotlib canvas for the graph
        self.figure = Figure()
        self.canvas = FigureCanvas(self.figure)
        layout.addWidget(self.canvas)

        self.setLayout(layout)

    def add_steps(self):
        try:
            steps = int(self.steps_input.text().strip())
            if steps < 0:
                QMessageBox.warning(self, "Error", "Steps cannot be negative.")
                return

            self.steps_data.append(steps)
            self.update_graph()
            self.steps_input.clear()
        except ValueError:
            QMessageBox.warning(self, "Error", "Please enter a valid number.")

    def update_graph(self):
        self.figure.clear()
        ax = self.figure.add_subplot(111)
        ax.plot(self.steps_data, marker='o', linestyle='-', color='b')
        ax.set_title("Steps Tracking")
        ax.set_xlabel("Entry Number")
        ax.set_ylabel("Steps")
        ax.grid(True)
        self.canvas.draw()


class SocialWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack

        layout = QVBoxLayout()
        title = QLabel("Social Chat")
        title.setStyleSheet("font-size: 18px; font-weight: bold;")
        layout.addWidget(title, alignment=Qt.AlignmentFlag.AlignCenter)

        # Chat history display
        self.chat_history = QTextEdit()
        self.chat_history.setReadOnly(True)  # Make it read-only
        layout.addWidget(self.chat_history)

        # Input field for user messages
        self.message_input = QLineEdit()
        self.message_input.setPlaceholderText("Enter your message here...")
        layout.addWidget(self.message_input)

        # Send button
        btn_send = QPushButton("Send")
        btn_send.setStyleSheet("background-color: lightgreen;")
        btn_send.clicked.connect(self.send_message)
        layout.addWidget(btn_send)

        # Back button
        btn_back = QPushButton("Back")
        btn_back.setStyleSheet("background-color: lightblue;")
        btn_back.clicked.connect(lambda: parent_stack.setCurrentIndex(4))
        layout.addWidget(btn_back)

        self.setLayout(layout)

        # Predefined messages from other users
        self.predefined_messages = [
            ("CEO", "Welcome to the gym! Let's stay fit together."),
            ("MIA", "I love the new yoga classes!"),
            ("JAMES", "Don't forget to hydrate during your workouts."),
        ]

        # Simulate predefined messages
        self.simulate_predefined_messages()

    def simulate_predefined_messages(self):
        """Simulate messages from predefined users."""
        for sender, message in self.predefined_messages:
            self.chat_history.append(f"<b>{sender}:</b> {message}")

    def send_message(self):
        """Send a message from the user."""
        user_message = self.message_input.text().strip()
        if user_message:
            self.chat_history.append(f"<b>You:</b> {user_message}")
            self.message_input.clear()
        else:
            QMessageBox.warning(self, "Error", "Please enter a message before sending.")


# -------------------- SETTINGS WINDOW (with dark mode) -------------------- #
class SettingWindow(QWidget):
    def __init__(self, parent_stack):
        super().__init__()
        self.parent_stack = parent_stack
        self.dark_mode = False  # Default light mode
        self.current_font = "Arial"  # Default font
        self.current_font_size = 12  # Default font size
        self.is_premium = False  # Default to non-premium

        # Main layout
        main_layout = QVBoxLayout()
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        main_layout.setContentsMargins(20, 20, 20, 20)
        main_layout.setSpacing(15)

        # Title
        title = QLabel("Settings")
        title.setStyleSheet("font-size: 22px; font-weight: bold; color: #333;")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        main_layout.addWidget(title)

        # Membership Status Section
        membership_section = QVBoxLayout()
        membership_section.setSpacing(10)

        membership_label_title = QLabel("Membership Status")
        membership_label_title.setStyleSheet("font-size: 18px; font-weight: bold; color: #555;")
        membership_section.addWidget(membership_label_title)

        self.membership_label = QLabel("Membership: Loading...")
        self.membership_label.setStyleSheet("font-size: 16px; color: #777;")
        self.membership_label.setAlignment(Qt.AlignmentFlag.AlignLeft)
        membership_section.addWidget(self.membership_label)

        main_layout.addLayout(membership_section)

        # Font Settings Section
        font_section = QVBoxLayout()
        font_section.setSpacing(10)

        font_label_title = QLabel("Font Settings")
        font_label_title.setStyleSheet("font-size: 18px; font-weight: bold; color: #555;")
        font_section.addWidget(font_label_title)

        # Font Selection
        font_label = QLabel("Select Font:")
        font_label.setStyleSheet("font-size: 14px; color: #555;")
        font_section.addWidget(font_label)

        self.font_dropdown = QComboBox()
        self.font_dropdown.addItems(QFontDatabase().families())  # Populate with available fonts
        self.font_dropdown.setCurrentText(self.current_font)
        self.font_dropdown.currentTextChanged.connect(self.change_font)
        font_section.addWidget(self.font_dropdown)

        # Font Size Adjustment
        font_size_label = QLabel("Adjust Font Size:")
        font_size_label.setStyleSheet("font-size: 14px; color: #555;")
        font_section.addWidget(font_size_label)

        self.font_size_slider = QSlider(Qt.Orientation.Horizontal)
        self.font_size_slider.setRange(8, 32)  # Font size range
        self.font_size_slider.setValue(self.current_font_size)
        self.font_size_slider.valueChanged.connect(self.change_font_size)
        font_section.addWidget(self.font_size_slider)

        main_layout.addLayout(font_section)

        # Appearance Options for Premium Users
        self.premium_appearance_section = QVBoxLayout()
        self.premium_appearance_section.setSpacing(10)

        appearance_label_title = QLabel("Appearance Options (Premium Only)")
        appearance_label_title.setStyleSheet("font-size: 18px; font-weight: bold; color: gold;")
        self.premium_appearance_section.addWidget(appearance_label_title)

        self.theme_dropdown = QComboBox()
        self.theme_dropdown.addItems(["Default", "Cool Blue", "Dark Purple", "Vibrant Green"])
        self.theme_dropdown.currentTextChanged.connect(self.change_theme)
        self.premium_appearance_section.addWidget(self.theme_dropdown)

        self.premium_appearance_section_widget = QWidget()
        self.premium_appearance_section_widget.setLayout(self.premium_appearance_section)
        self.premium_appearance_section_widget.setVisible(False)  # Hidden by default
        main_layout.addWidget(self.premium_appearance_section_widget)

        # Dark Mode Section
        dark_mode_section = QVBoxLayout()
        dark_mode_section.setSpacing(10)

        dark_mode_label_title = QLabel("Appearance")
        dark_mode_label_title.setStyleSheet("font-size: 18px; font-weight: bold; color: #555;")
        dark_mode_section.addWidget(dark_mode_label_title)

        self.toggle_mode_btn = QPushButton("Switch to Dark Mode")
        self.toggle_mode_btn.setStyleSheet("background-color: #ddd; padding: 8px; border-radius: 5px;")
        self.toggle_mode_btn.clicked.connect(self.toggle_mode)
        dark_mode_section.addWidget(self.toggle_mode_btn)

        main_layout.addLayout(dark_mode_section)

        # Back Button
        btn_back = QPushButton("Back")
        btn_back.setStyleSheet("""
            background-color: #4CAF50;
            color: white;
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
        """)
        btn_back.clicked.connect(lambda: parent_stack.setCurrentIndex(4))
        main_layout.addWidget(btn_back, alignment=Qt.AlignmentFlag.AlignCenter)

        self.setLayout(main_layout)

    def toggle_mode(self):
        self.dark_mode = not self.dark_mode

        if self.dark_mode:
            QApplication.instance().setStyleSheet("""
                QWidget {
                    background-color: #2E2E2E;
                    color: #FFFFFF;
                }
                QPushButton {
                    background-color: #3C3C3C;
                    color: white;
                    border: 1px solid #555;
                    border-radius: 5px;
                    padding: 5px;
                }
                QPushButton:hover {
                    background-color: #505050;
                }
                QLineEdit {
                    background-color: #404040;
                    color: white;
                    border: 1px solid #666;
                    border-radius: 3px;
                }
            """)
            self.toggle_mode_btn.setText("Switch to Light Mode")
            self.toggle_mode_btn.setStyleSheet("background-color: #5A5A5A; color: white;")
        else:
            QApplication.instance().setStyleSheet("""
                QWidget {
                    background-color: #F0F0F0;
                    color: black;
                }
                QPushButton {
                    background-color: #E0E0E0;
                    color: black;
                    border: 1px solid #AAA;
                    border-radius: 5px;
                    padding: 5px;
                }
                QPushButton:hover {
                    background-color: #D6D6D6;
                }
                QLineEdit {
                    background-color: white;
                    color: black;
                    border: 1px solid #CCC;
                    border-radius: 3px;
                }
            """)
            self.toggle_mode_btn.setText("Switch to Dark Mode")
            self.toggle_mode_btn.setStyleSheet("background-color: #ddd; color: black;")

    def change_font(self, font_name):
        """Change the font of all text in the application."""
        self.current_font = font_name
        QApplication.instance().setFont(QFont(self.current_font, self.current_font_size))

    def change_font_size(self, font_size):
        """Change the font size of all text in the application."""
        self.current_font_size = font_size
        QApplication.instance().setFont(QFont(self.current_font, self.current_font_size))

    def change_theme(self, theme_name):
        """Change the application's theme based on the selected option."""
        if theme_name == "Cool Blue":
            QApplication.instance().setStyleSheet("""
                QWidget {
                    background-color: #E3F2FD;
                    color: #0D47A1;
                }
                QPushButton {
                    background-color: #64B5F6;
                    color: white;
                    border-radius: 5px;
                    padding: 8px;
                }
                QPushButton:hover {
                    background-color: #42A5F5;
                }
            """)
        elif theme_name == "Dark Purple":
            QApplication.instance().setStyleSheet("""
                QWidget {
                    background-color: #311B92;
                    color: #EDE7F6;
                }
                QPushButton {
                    background-color: #673AB7;
                    color: white;
                    border-radius: 5px;
                    padding: 8px;
                }
                QPushButton:hover {
                    background-color: #5E35B1;
                }
            """)
        elif theme_name == "Vibrant Green":
            QApplication.instance().setStyleSheet("""
                QWidget {
                    background-color: #E8F5E9;
                    color: #1B5E20;
                }
                QPushButton {
                    background-color: #66BB6A;
                    color: white;
                    border-radius: 5px;
                    padding: 8px;
                }
                QPushButton:hover {
                    background-color: #43A047;
                }
            """)
        else:  # Default theme
            QApplication.instance().setStyleSheet("")

    def update_membership_status(self, username):
        """Update the membership status label and show Premium options if applicable."""
        user_data = query_database("SELECT u_sub FROM User WHERE user_name = ?", (username,))
        if user_data:
            self.is_premium = user_data[0][0] == 1
            membership_type = "Premium" if self.is_premium else "Free"
            self.membership_label.setText(f"Membership: {membership_type}")
            self.premium_appearance_section_widget.setVisible(self.is_premium)
        else:
            self.membership_label.setText("Membership: Unknown")
            self.premium_appearance_section_widget.setVisible(False)


# -------------------- MAIN APPLICATION -------------------- #
class TokafitnessApp(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("TOKAFITNESS")
        self.resize(420, 450)



        self.stack = QStackedWidget()
        self.stack.addWidget(MainMenu(self.stack))          # 0
        self.stack.addWidget(LoginWindow(self.stack))       # 1
        self.stack.addWidget(SignupWindow(self.stack))      # 2
        self.stack.addWidget(ForgotPasswordWindow(self.stack)) # 3
        self.stack.addWidget(DashboardWindow(self.stack))   # 4
        self.stack.addWidget(AdviceWindow(self.stack))      # 5
        self.stack.addWidget(BookingWindow(self.stack))     # 6
        self.stack.addWidget(PremiumWindow(self.stack))     # 7
        self.stack.addWidget(TrackingWindow(self.stack))    # 8
        self.stack.addWidget(SocialWindow(self.stack))      # 9
        self.stack.addWidget(SettingWindow(self.stack))     # 10


        layout = QVBoxLayout()
        layout.addWidget(self.stack)
        self.setLayout(layout)



if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = TokafitnessApp()
    window.show()
    sys.exit(app.exec())
